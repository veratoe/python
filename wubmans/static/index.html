<!doctype html>
<html>
    <head>
    
        <style>

            html, body {
                font-family: sans-serif;
            }

            .container {
                width: 960px;
                margin: 0 auto;
            }

            .blob {
                background-color: #fcffee;
                border: 1px solid #ccc;
                margin-bottom: 10px;
                font-family: monospace;
                padding: 20px;
                color: #444;
                border-radius: 5px;
                transition: background-color 1000ms linear;

            }

            .blob.active {
                background-color: #dee9fd;
            }

            .blob span.improved {
                font-weight: bold;
                color: green;
                float: right;
            }

            .status {
                font-family: monospace;
                padding: 20px;
                background-color: #eee;
                margin-bottom: 10px;
                border-radius: 5px;
            }

            .status label {
                color: #aaa;
            }

            .stats {
                color: #de8a8a;
                margin-top: 10px;
            }
            
            p {
                font-family: serif;
            }

            canvas {
                position: fixed;
                top: 10
            }

            @media only screen and (max-device-width: 768px) { 
            
                .container {
                    width: 80%;
                    margin: 0 auto;
                }
                .mob_hide {
                    display: none !important;
                }

                p {
                    padding: 20px 0px;
                }

            }

        </style>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.bundle.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    
    </head>
    <body>

        <canvas id="loss_chart" width="400" height="300" class="mob_hide"></canvas>

        <div class="container">
            <div class="header">
            <h2>LE NIETZSCHE generator</h2>
            <div class="status">
                <span><label>Batch:</label> <span id="status_batch">0</span></span>
                <span><label>Loss:</label> <span id="status_loss">0</span></span>
                <span><label>Iteration:</label> <span id="status_iteration">0</span></span>
                <span style="float: right"><label>Time:</label> <span id="status_time">0:00</span></span>
            </div>

            <div id="blobs_list">
                ... LOADING ...
            </div>

        </div>

        <script id="blobs_template" type="text/template">

            <div class="blob" id="{{ iteration }}">
                <p><span style="font-weight: bold;" title="seed">{{ seed }}</span><span>{{ result_text }}</span></p>
                <div class="stats">
                    <span>Epoch: <strong>{{ iteration }}</strong></span> 
                    <span>Loss: <strong>{{ loss }}</strong></span>
                    <span>Tijd: <strong>{{ time }}</strong></span>
                    <span class="improved">{{ model_improved }}</span>
                </div>
            </div>

        </script>

        <script>

            var results, 
                status, 
                status_pending,
                current_iteration = 0;

            var loadResults = function () {

                $.getJSON('results', function(data) { 
                    r = data.split("#@#");
                    r = r.map(function(json) { 
                        try {
                            var j = JSON.parse(json);
                            j.model_improved = j.model_improved == "true" ? "MODEL VERBETERD" : "";
                            j.loss = Number(j.loss).toFixed(4);
                            if (j.time) {
                                var minutes = Math.floor(Number(j.time) / 60)
                                var seconds = Math.floor(Number(j.time) % 60)
                                j.time = minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
                            } else {
                                j.time = "-"
                            }   

                            return j;
                        }
                        catch(e) {
                        }

                    });

                    r = r.filter(function (item) { return typeof item === "object" });

                    for (var i = 0; i < r.length; i++) {
                        r[i].iteration = i
                    }
                    
                    results = r;

                    renderBlobs();
                    createChart();
                })

            }

            setInterval(function () {

                if (status_pending) {
                    console.log('adfa');
                    return;
                }

                status_pending = true;

                $.getJSON('status', function(data) { 

                    var status;

                    try {
                        status = JSON.parse(data);
                    }

                    catch(e) {
                        status_pending = false;
                    }

                    if (!status) {
                        return;
                    } 

                    status.loss = Number(status.loss).toFixed(4);
                    var minutes = Math.floor(Number(status.time) / 60)
                    var seconds = Math.floor(Number(status.time) % 60)
                    status.time = minutes + ":" + (seconds < 10 ? "0" : "") + seconds;

                    for (var key in status) {
                        $("#status_" + key).text(status[key])
                    };

                    if (current_iteration !== status.iteration) {
                        current_iteration = status.iteration;
                        loadResults();
                    }

                    status_pending = false;

                })
                
            }, 10)


            var renderBlobs = function () {
            
                var template = $("#blobs_template").html();
                var html = "";
                results.slice().reverse().forEach(function (r) {
                    html += renderHTML(template, r);
                })

                $("#blobs_list").html(html);
            }


            var renderHTML = function (html, data) {

                for (var key in data) {
                    var regex = new RegExp( "{{\\s+" + key + "\\s+}}", "g" );
                    html = html.replace(regex, data[key]);
                }

                return html;

            }

        </script>

        <script>

            var ctx = document.getElementById("loss_chart").getContext("2d");

            var createChart = function () {

                var labels = results.map(function(item, index) {
                   return index; 
                });

                var data = results.map(function(item) {
                    return item.loss;
                });

                new Chart(ctx, {

                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: "rgb(255, 99, 132)",
                            borderColor: "none",
                            fill: false
                        }]
                    },
                    options: { 
                        legend: {
                            display: false
                        },
                        responsive: false,
                        scales: {
                            xAxes: [{
                                gridLines: {
                                    display: false
                                },
                                ticks: {
                                    padding: 20,
                                    //display: false,
                                    maxTicksLimit: 10,
                                }
                            }],
                            yAxes: [{
                                gridLines: {
                                    display: false
                                },
                                ticks: {
                                    maxTicksLimit: 5 
                                }
                            }]
                        },
                        onClick: function (a, b) { 
                            console.log(b[0])
                            if (!b || typeof b !== "object") return;
                            var $blob = $(".blob#" + (b[0]._index + 1));
                            $("html, body").animate({ scrollTop: $blob.offset().top - 100 })
                            $(".blob").removeClass("active");
                            $blob.addClass("active");

                        }
                    }

                });

            }

        </script>

    </body>

</html>
